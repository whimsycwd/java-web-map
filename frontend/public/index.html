<html>
<head>
    <!-- <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /> -->
    <!-- // <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->

    <link rel="stylesheet" type="text/css" href="./leaflet.css">
    <script type="text/javascript" src="./jquery.js"></script> 
    <!-- // must go before leaflet-src.js  -->
    <script type="text/javascript" src="./leaflet-src.js"></script>

    <script type="text/javascript" src="./js/bootstrap.js"></script>


    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.css">
    <!-- Bootstrap theme CSS -->
    <link rel="stylesheet" type="text/css" href="./css/bootstrap-theme.css">

    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    
    <link rel="stylesheet" type="text/css" href="./leaflet-self.css">
</head>
<body>




<form class="form-inline">
  <div class="form-group">
    <div class="input-group">
      <div class="input-group-addon">起点</div>
      <input type="text" class="form-control" id="source" placeholder="type here">    
    </div>

    <div class="input-group">
      <div class="input-group-addon">终点</div>
      <input type="text" class="form-control" id="target" placeholder="type here">
    </div>
  </div>
  <button type="submit" class="btn btn-primary">路径规划</button>
</form>


  <script>

 
    $( "#source" ).autocomplete({
      source: function( request, response ) {
        $.ajax({
          url: "http://127.0.0.1:8080/api/map/suggest/",
          dataType: "jsonp",
          data: {
            q: request.term
          },
          success: function( data ) {
            response( data );
          }
        });
      },
      minLength: 1
    });


    $( "#target" ).autocomplete({
      source: function( request, response ) {
        $.ajax({
          url: "http://127.0.0.1:8080/api/map/suggest/",
          dataType: "jsonp",
          data: {
            q: request.term
          },
          success: function( data ) {
            response( data );
          }
        });
      },
      minLength: 1
    });
  
  </script>

<div id="map"></div>

<script>
    var map = L.map('map').setView([30.6765553, 104.0612783], 15);
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
    }).addTo(map);


    var paintPath = function(sId, tId) {
        $.get("api/map/routing/" + sId + "/" + tId, function(data){
            var obj = data;

            var latlngs = [];

            obj.paths.forEach(function(e) {
                latlngs.push(L.latLng(e.y, e.x));

            });
            var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map);
        });
    } 
 

    var ids = [];

    map.on('click', function(e) {
//        L.marker(e.latlng).addTo(map);
        

        $.get("/api/map/nearest/" + e.latlng.lng + "/" + e.latlng.lat, function(data) {
            var marker = L.marker(L.latLng(data.y, data.x));
            marker.addTo(map);


            marker.bindPopup("popupContent <input type='text' />").openPopup();
            ids.push(data.id);

            if (ids.length % 2 == 0) {
                paintPath(ids[ids.length - 2], ids[ids.length - 1]);
            }
        });

       // alert(e.latlng);
    });
</script>



</body>
</html>